{"expireTime":9007200894083853000,"key":"transformer-remark-markdown-html-26fc56b5fcb72e5583bd579d6237993a-gatsby-remark-imagesgatsby-remark-external-linksgatsby-remark-prismjs-","val":"<h1>usando PassportJS en NODE</h1>\n<ul>\n<li>\n<h2>requerimientos instalacion</h2>\n</li>\n<li>\n<p>listado packages npm</p>\n<ul>\n<li>\n<pre>\npassport\npassport-google-oauth20\n</pre>\n</li>\n</ul>\n</li>\n<li>\n<p>complementos</p>\n<ul>\n<li><a href=\"http://www.passportjs.org/packages/passport-google-oauth20/\" target=\"_blank\" rel=\"nofollow\">documentacion de passportJS</a></li>\n</ul>\n</li>\n<li>paso 1 en el proyecto</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm i passport passport-google-oauth20</code></pre></div>\n<ul>\n<li>\n<p>paso 2 en el navegador web</p>\n<ol>\n<li>ingresar a <a href=\"https://console.developers.google.com/\" target=\"_blank\" rel=\"nofollow\">Developer Console de Google</a></li>\n<li>crear PROYECTO ejemplo <strong>passportjs-practicaoauth2</strong></li>\n<li>ingresa a <strong>Credentials</strong> y asegurate de tener seleccionado tu aplicacion</li>\n<li>ir a <strong>CONFIGURAR PANTALLA DE CONSENTIMIENTO</strong> O <strong>CONFIGURE CONSENT SCREEN</strong></li>\n<li>Marcar opciones [User type : EXTERNAL] y \"CREAR\"</li>\n<li>asignar:\na. nombre a la app <strong>passportjs-practicaoauth2</strong>\nb. correo a la app para asistencias\nc. correo del developer y \"Guardar y continuar\"</li>\n<li>Regresar a <strong>Credentials</strong> e ir a <strong>create credentials</strong> selecciona <strong>OAUTH client ID</strong>\na. selecciona tipo de aplicacion : \"aplicacion web\"\nb. nombre <strong>passportjs-practicaoauth2</strong>\nc. URI de redireccionamiento autorizados : <strong><a href=\"http://localhost:3000/google/callback\" target=\"_blank\" rel=\"nofollow\">http://localhost:3000/google/callback</a></strong></li>\n<li>Ahora recibes tus datos de acceso!\na. tu ID CLIENTE: 416807314987-n43k7d1bqo7mbspglqsdqousk4vcfmhk.apps.googleusercontent.com\nb. tu ID secreto del CLIENTE: saXjPDAmNtVWVZfIEHxq3BRd</li>\n</ol>\n</li>\n<li>paso 3 en el proyecto</li>\n</ul>\n<p>new file authenticate.js en la raiz</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">var passport = require(&#39;passport&#39;)\nvar GoogleStrategy = require(&#39;passport-google-oauth20&#39;).Strategy;\n//import passport from &#39;passport&#39;\n//import GoogleStrategy from &quot;passport-google-oauth20&quot;;\n//const Google = GoogleStrategy.Strategy;\n\n\n/*serializacion de datos*/\npassport.serializeUser(function(user, done) {\n  done(null, user);\n});\n\npassport.deserializeUser(function(user, done) {\n  done(null, user);\n});\n/*basic configure*/\npassport.use(new GoogleStrategy({\n    clientID: &quot;416807314987-n43k7d1bqo7mbspglqsdqousk4vcfmhk.apps.googleusercontent.com&quot;,\n    clientSecret: &quot;saXjPDAmNtVWVZfIEHxq3BRd&quot;,\n    callbackURL: &quot;http://localhost:3000/google/callback&quot;\n  },\n  function(accessToken, refreshToken, profile, cb) {\n      /*Usuario Registrados*/\n      console.log(profile);\n      cb(null,profile)\n\n  }\n));</code></pre></div>\n<p>en app.js importar</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">var passport = require(&#39;passport&#39;)// necesario\n//import passport from &#39;passport&#39;;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/*revisando passport*/\napp.use(passport.initialize())\nrequire(&#39;./authenticate&#39;); // o import\napp.get(&#39;/google&#39;, passport.authenticate(&#39;google&#39;, { scope: [&#39;profile&#39;, &#39;email&#39;] }));\napp.get(&#39;/google/callback&#39;,    passport.authenticate(&#39;google&#39;, {\n      successRedirect: &#39;/welcome&#39;, // es una &#39;vista&#39;\n      failureRedirect: &#39;/failed&#39;,  // es una &#39;vista&#39;\n    }));</code></pre></div>\n<ul>\n<li>probar alguna ruta\nir a <a href=\"http://localhost:3000/google\" target=\"_blank\" rel=\"nofollow\">http://localhost:3000/google</a> y logearse para ser rerigido a la vista/ruta /welcome</li>\n</ul>\n<h1>proteger rutas con un middlware</h1>\n<p><strong>debe ser accesible solo para los que esten logeados</strong></p>\n<p>1- crear MIDDLEWARE/proteccion check is logged or not</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">export function isLogged(req, res, next) { // revisa\n  req.user ? next() : res.sendStatus(401); // revisa google trae usuario\n}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">app.use(&#39;/&#39;,isLogged, mivistahome);</code></pre></div>\n<h1>agregar sessiones para permitirnos ingrsar :]</h1>\n<p>2- usar sessions , npm i express-session</p>\n<ul>\n<li>key , inicializa , inicializa session</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">app.use(session({ secret: &#39;boby&#39; })); // set my session key\napp.use(passport.initialize()); // session start\napp.use(passport.session()); // session for passport</code></pre></div>\n<ul>\n<li>y podemos crear el logout</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">loginRouter.get(&#39;/logout&#39;, (req,res)=&gt;{\n  req.logout();\n  req.session.destroy()\n  // req.session.destroy()\n  res.send(&#39;bye!!&#39;);\n})</code></pre></div>\n<p>si logramos autenticarnos los dato se guardarne n\nreq.session y este contendra varios objetos uno es PASSPORT , que\nes el que creamos normlamente en app.js 'app.use(passpor.session())'</p>\n<!-- req.session.user = req.user;  -->\n<p>si imprimimos req.session en el Middleware de isLogged lo vemos.</p>\n<ul>\n<li>req.session</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Session {\n  cookie: { path: &#39;/&#39;, _expires: null, originalMaxAge: null, httpOnly: true },\n  passport: {\n    user: {\n      id: &#39;107809872631362401677&#39;,\n      displayName: &#39;HylianN 92&#39;,\n      name: [Object],\n      emails: [Array],\n      photos: [Array],\n      provider: &#39;google&#39;,\n      _raw: &#39;{\\n&#39; +\n        &#39;  &quot;sub&quot;: &quot;107809872631362401677&quot;,\\n&#39; +\n        &#39;  &quot;name&quot;: &quot;HylianN 92&quot;,\\n&#39; +\n        &#39;  &quot;given_name&quot;: &quot;HylianN&quot;,\\n&#39; +\n        &#39;  &quot;family_name&quot;: &quot;92&quot;,\\n&#39; +\n        &#39;  &quot;picture&quot;: &quot;https://lh3.googleusercontent.com/a-/AOh14GgdK0REtqYRffIuJTZokeTnYB_UncprsTyH18Y6eA\\\\u003ds96-c&quot;,\\n&#39; +\n        &#39;  &quot;email&quot;: &quot;hyliankz@gmail.com&quot;,\\n&#39; +\n        &#39;  &quot;email_verified&quot;: true,\\n&#39; +\n        &#39;  &quot;locale&quot;: &quot;es-419&quot;\\n&#39; +\n        &#39;}&#39;,\n      _json: [Object]\n    }\n  }\n}</code></pre></div>\n<p>req.session.passport.user.X</p>"}